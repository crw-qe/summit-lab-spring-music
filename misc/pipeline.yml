apiVersion: v1
kind: BuildConfig
metadata:
  name: spring-music-pipeline
spec:
  strategy:
    type: JenkinsPipeline
    jenkinsPipelineStrategy:
      jenkinsfile: |-
        pipeline {
          agent any
          stages {
            stage('Build') {
              steps {
                script {
                  openshift.withCluster() {
                    openshift.withProject() {
                      openshift.startBuild("spring-music").logs('-f')
                    }
                  }
                }
              }
            }
            stage('Deploy') {
              steps {
                script {
                  openshift.withCluster() {
                    openshift.withProject() {
                      dc = openshift.selector("dc", "spring-music")
                      dc.rollout().latest()
                      timeout(10) {
                          dc.rollout().status("-w")
                      }
                    }
                  }
                }
              }
            }
            stage('Test') {
              steps {
                sh "curl -s http://spring-music:8080/actuator/health | grep 'UP'"
              }
            }
          }
        }
